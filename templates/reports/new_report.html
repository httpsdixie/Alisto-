{% extends "base.html" %}

{% block title %}Submit New Report{% endblock %}

{% block content %}
<!-- Loading Overlay -->
<div id="loadingOverlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 9999; justify-content: center; align-items: center;">
    <div class="text-center text-white">
        <div class="spinner-border" role="status" style="width: 4rem; height: 4rem;">
            <span class="visually-hidden">Loading...</span>
        </div>
        <h4 class="mt-3">Uploading your report...</h4>
        <p>Please wait, this may take a moment.</p>
    </div>
</div>

<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-primary text-white py-3">
                <h5 class="mb-0">
                    <i class="bi bi-plus-circle me-2"></i>Submit New Safety Report
                </h5>
            </div>
            <div class="card-body p-4">
                <form method="POST" action="/report/new" enctype="multipart/form-data" id="reportForm">
                    
                    <div class="mb-3">
                        <label for="title" class="form-label">
                            <i class="bi bi-card-heading me-1"></i>Report Title <span class="text-danger">*</span>
                        </label>
                        <input type="text" class="form-control" id="title" name="title" placeholder="Brief description of the issue" required minlength="5" maxlength="200">
                        <small class="text-muted">5-200 characters</small>
                    </div>
                    
                    <div class="mb-3">
                        <label for="location" class="form-label">
                            <i class="bi bi-geo-alt me-1"></i>Location <span class="text-danger">*</span>
                        </label>
                        <input type="text" class="form-control" id="location" name="location" placeholder="e.g., Building A, 2nd Floor, Room 201" required>
                        <small class="text-muted">Be as specific as possible.</small>
                    </div>
                    
                    <div class="mb-3">
                        <label for="description" class="form-label">
                            <i class="bi bi-text-paragraph me-1"></i>Description <span class="text-danger">*</span>
                        </label>
                        <textarea class="form-control" id="description" name="description" rows="5" placeholder="Provide detailed information about the issue..." required minlength="10"></textarea>
                        <small class="text-muted">Minimum 10 characters. Include relevant details that will help address the issue.</small>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="category" class="form-label">
                                <i class="bi bi-tag me-1"></i>Category <span class="text-danger">*</span>
                            </label>
                            <select class="form-select" id="category" name="category" required>
                                <option value="">Select Category</option>
                                <option value="Infrastructure">Infrastructure</option>
                                <option value="Safety Hazard">Safety Hazard</option>
                                <option value="Electrical">Electrical</option>
                                <option value="Plumbing">Plumbing</option>
                                <option value="Sanitation">Sanitation</option>
                                <option value="Security">Security</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="priority" class="form-label">
                                <i class="bi bi-exclamation-circle me-1"></i>Priority Level <span class="text-danger">*</span>
                            </label>
                            <select class="form-select" id="priority" name="priority" required>
                                <option value="Low">Low</option>
                                <option value="Medium" selected>Medium</option>
                                <option value="High">High</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <label class="form-label">
                            <i class="bi bi-camera me-1"></i>Photo Evidence (Optional)
                        </label>
                        <div class="row g-2 mb-2">
                            <div class="col-6">
                                <button type="button" class="btn btn-outline-primary w-100" id="capturePhotoBtn">
                                    <i class="bi bi-camera-fill me-2"></i>Take Photo
                                </button>
                            </div>
                            <div class="col-6">
                                <label class="btn btn-outline-secondary w-100 mb-0" for="photo">
                                    <i class="bi bi-upload me-2"></i>Upload File
                                </label>
                                <input type="file" class="d-none" id="photo" name="photo" accept="image/*">
                            </div>
                        </div>
                        <small class="text-muted">Max 5MB. Supported formats: JPG, PNG, GIF</small>
                        
                        <div id="cameraContainer" class="mt-3" style="display: none;">
                            <div class="card bg-dark">
                                <div class="card-body p-2">
                                    <video id="cameraVideo" class="w-100 rounded" style="max-height: 300px;" autoplay playsinline></video>
                                    <canvas id="cameraCanvas" style="display: none;"></canvas>
                                    <div class="d-flex gap-2 justify-content-center mt-2">
                                        <button type="button" class="btn btn-warning" id="takePhotoBtn">
                                            <i class="bi bi-camera me-1"></i>Capture
                                        </button>
                                        <button type="button" class="btn btn-light" id="closeCameraBtn">
                                            <i class="bi bi-x-circle me-1"></i>Cancel
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div id="imagePreview" class="mt-3" style="display: none;">
                            <div class="position-relative d-inline-block">
                                <img id="previewImg" src="" class="img-fluid rounded" style="max-height: 200px;">
                                <button type="button" class="btn btn-sm btn-danger position-absolute top-0 end-0 m-1" id="removePhotoBtn">
                                    <i class="bi bi-x"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-warning btn-lg">
                            <i class="bi bi-send me-2"></i>Submit Report
                        </button>
                        <a href="/dashboard" class="btn btn-outline-secondary btn-lg">
                            <i class="bi bi-x me-2"></i>Cancel
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Confirmation Modal -->
<div class="modal fade" id="submitConfirmModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-warning">
                <h5 class="modal-title">
                    <i class="bi bi-exclamation-triangle me-2"></i>Important Notice
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="mb-3"><strong>Once you submit this report, you will NOT be able to edit it.</strong></p>
                <p class="text-muted mb-0">Please review all the information carefully before submitting. Your report will be sent to the maintenance team for review.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-arrow-left me-2"></i>Go Back & Review
                </button>
                <button type="button" class="btn btn-warning" id="confirmSubmitBtn">
                    <i class="bi bi-check-circle me-2"></i>Submit Report
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
let cameraStream = null;
let reportForm = null;
let confirmModal = null;

document.addEventListener('DOMContentLoaded', function() {
    reportForm = document.getElementById('reportForm');
    confirmModal = new bootstrap.Modal(document.getElementById('submitConfirmModal'));
    
    // Intercept form submission
    reportForm.addEventListener('submit', function(e) {
        e.preventDefault();
        confirmModal.show();
    });
    
    // Handle confirm button click
    document.getElementById('confirmSubmitBtn').addEventListener('click', function() {
        confirmModal.hide();
        // Show loading overlay
        document.getElementById('loadingOverlay').style.display = 'flex';
        reportForm.submit();
    });
});

document.getElementById('photo').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
        showImagePreview(file);
    }
});

function showImagePreview(file) {
    const preview = document.getElementById('imagePreview');
    const previewImg = document.getElementById('previewImg');
    const reader = new FileReader();
    reader.onload = function(e) {
        previewImg.src = e.target.result;
        preview.style.display = 'block';
    };
    reader.readAsDataURL(file);
}

document.getElementById('removePhotoBtn').addEventListener('click', function() {
    document.getElementById('photo').value = '';
    document.getElementById('imagePreview').style.display = 'none';
    document.getElementById('previewImg').src = '';
});

document.getElementById('capturePhotoBtn').addEventListener('click', async function() {
    const cameraContainer = document.getElementById('cameraContainer');
    const video = document.getElementById('cameraVideo');
    
    try {
        cameraStream = await navigator.mediaDevices.getUserMedia({ 
            video: { facingMode: 'environment' },
            audio: false 
        });
        video.srcObject = cameraStream;
        cameraContainer.style.display = 'block';
    } catch (err) {
        alert('Could not access camera. Please use file upload instead.');
        console.error('Camera error:', err);
    }
});

document.getElementById('closeCameraBtn').addEventListener('click', function() {
    stopCamera();
});

document.getElementById('takePhotoBtn').addEventListener('click', function() {
    const video = document.getElementById('cameraVideo');
    const canvas = document.getElementById('cameraCanvas');
    const context = canvas.getContext('2d');
    
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    context.drawImage(video, 0, 0);
    
    canvas.toBlob(function(blob) {
        const file = new File([blob], 'camera_photo.jpg', { type: 'image/jpeg' });
        const dataTransfer = new DataTransfer();
        dataTransfer.items.add(file);
        document.getElementById('photo').files = dataTransfer.files;
        showImagePreview(file);
        stopCamera();
    }, 'image/jpeg', 0.85);
});

function stopCamera() {
    if (cameraStream) {
        cameraStream.getTracks().forEach(track => track.stop());
        cameraStream = null;
    }
    document.getElementById('cameraContainer').style.display = 'none';
}

</script>
{% endblock %}
