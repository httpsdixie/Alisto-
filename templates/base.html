<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>{% block title %}ALISTO!{% endblock %} - EVSU-OC Campus Safety</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Montserrat:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="/static/css/style.css" rel="stylesheet">
    {% block extra_css %}{% endblock %}
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-white border-bottom sticky-top" style="box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
        <div class="container-fluid px-3">
            <a class="navbar-brand fw-bold text-white" href="/" style="font-size: 1.3rem;">
                <i class="bi bi-shield-check me-1"></i>ALISTO!
            </a>
            
            {% if current_user %}
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto align-items-center gap-1">
                    {% if current_user.is_admin %}
                        <li class="nav-item">
                            <a class="nav-link" href="/admin/dashboard">Dashboard</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/admin/reports">All Reports</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/admin/users">Users</a>
                        </li>
                    {% else %}
                        <li class="nav-item">
                            <a class="nav-link" href="/dashboard">Dashboard</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/report/new">New Report</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/my-reports">My Reports</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/track-report">Track</a>
                        </li>
                    {% endif %}
                    <li class="nav-item">
                        {% if current_user.is_admin %}
                            <a class="nav-link" href="/admin/guide">Admin Guide</a>
                        {% else %}
                            <a class="nav-link" href="/help">Help</a>
                        {% endif %}
                    </li>
                    <li class="nav-item ms-2">
                        {% if current_user.is_admin %}
                            <button class="btn btn-outline-light btn-sm position-relative" data-bs-toggle="offcanvas" data-bs-target="#notificationPanel" onclick="markNotificationsRead()" title="View Notifications">
                                <i class="bi bi-bell-fill text-white"></i>
                                <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" id="notif-badge" style="display: none;">0</span>
                            </button>
                        {% else %}
                            <button class="btn btn-outline-light btn-sm position-relative" data-bs-toggle="offcanvas" data-bs-target="#userNotificationPanel" title="Report Status Updates">
                                <i class="bi bi-bell-fill text-white"></i>
                                <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-warning text-dark" id="user-notif-badge" style="display: none;"></span>
                            </button>
                        {% endif %}
                    </li>
                    <li class="nav-item dropdown ms-1">
                        <a class="nav-link dropdown-toggle text-dark" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown">
                            <i class="bi bi-person-circle me-1"></i>{{ current_user.full_name }}
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="/profile"><i class="bi bi-person me-2"></i>Profile</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item text-danger" href="/logout"><i class="bi bi-box-arrow-right me-2"></i>Logout</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
            {% else %}
            <div class="ms-auto d-flex gap-2 align-items-center">
                <a class="nav-link text-white" href="/login">Log In</a>
                <a class="btn btn-primary btn-sm px-3" href="/register">Sign Up</a>
            </div>
            {% endif %}
        </div>
    </nav>

    <main class="py-4">
        <div class="container">
            {% if flash_message %}
                {% set parts = flash_message.split(':', 1) %}
                {% if parts|length == 2 %}
                    {% set category = parts[0] %}
                    {% set message = parts[1] %}
                    <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                        {% if category == 'success' %}
                            <i class="bi bi-check-circle me-2"></i>
                        {% elif category == 'danger' %}
                            <i class="bi bi-exclamation-triangle me-2"></i>
                        {% elif category == 'warning' %}
                            <i class="bi bi-exclamation-circle me-2"></i>
                        {% else %}
                            <i class="bi bi-info-circle me-2"></i>
                        {% endif %}
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                {% endif %}
            {% endif %}
            
            {% block content %}{% endblock %}
        </div>
    </main>

    <!-- User Report Status Notifications -->
    <div class="offcanvas offcanvas-end" tabindex="-1" id="userNotificationPanel">
        <div class="offcanvas-header bg-primary text-white">
            <h5 class="offcanvas-title"><i class="bi bi-bell-fill me-2"></i>Report Updates</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas"></button>
        </div>
        <div class="offcanvas-body p-0" id="userNotifContent">
            <div class="text-center p-5">
                <i class="bi bi-hourglass-split display-6 text-muted"></i>
                <p class="text-muted mt-3">Loading updates...</p>
            </div>
        </div>
    </div>

    <!-- Notifications Offcanvas Panel -->
    <div class="offcanvas offcanvas-end" tabindex="-1" id="notificationPanel">
        <div class="offcanvas-header bg-danger text-white">
            <h5 class="offcanvas-title"><i class="bi bi-bell-fill me-2"></i>Notifications</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas"></button>
        </div>
        <div class="offcanvas-body p-0" id="notificationContent">
            <div class="text-center py-5">
                <i class="bi bi-bell-slash display-6 text-muted"></i>
                <p class="text-muted mt-3">Loading notifications...</p>
            </div>
        </div>
    </div>

    <!-- Hidden template for notifications (will be populated via JS) -->
    <div style="display: none;">
        <div id="notification-template">
            {% if notifications %}
                <div class="list-group list-group-flush">
                    {% for notification in notifications %}
                    <div class="list-group-item border-bottom">
                        <div class="p-3">
                            {% if notification.type == 'report_deleted' %}
                                <div class="d-flex align-items-start gap-2 mb-2">
                                    <i class="bi bi-trash text-danger fs-5 mt-1 flex-shrink-0"></i>
                                    <div>
                                        <h6 class="mb-1">Report <code class="text-danger">{{ notification.report_ticket_id }}</code> Deleted</h6>
                                        <small class="text-muted d-block">By: <strong>{{ notification.user_name }}</strong> ({{ notification.user_student_id }})</small>
                                    </div>
                                </div>
                                <div class="alert alert-light py-2 px-2 mb-2 border-start border-danger border-3">
                                    <small class="text-muted d-block mb-1"><strong>Reason:</strong></small>
                                    <small>{{ notification.deletion_reason }}</small>
                                </div>
                            {% elif notification.type == 'report_submitted' %}
                                <div class="d-flex align-items-start gap-2 mb-2">
                                    <i class="bi bi-file-earmark-plus text-success fs-5 mt-1 flex-shrink-0"></i>
                                    <div>
                                        <h6 class="mb-1">New Report <code class="text-success">{{ notification.report_ticket_id }}</code> Submitted</h6>
                                        <small class="text-muted d-block">By: <strong>{{ notification.user_name }}</strong> ({{ notification.user_student_id }})</small>
                                    </div>
                                </div>
                                <div class="alert alert-light py-2 px-2 mb-2 border-start border-success border-3">
                                    <small class="text-muted d-block mb-1"><strong>Title:</strong></small>
                                    <small>{{ notification.report_title }}</small>
                                </div>
                            {% endif %}
                            <small class="text-muted d-block">{{ notification.created_at.strftime('%b %d, %Y %I:%M %p') }}</small>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            {% endif %}
        </div>
    </div>

    <footer class="bg-black text-white py-2 mt-3">
        <div class="container text-center">
            <p class="mb-0" style="font-size: 0.75rem;">
                Copyright &copy; 2024 ALISTO! - EVSU-OC Campus Safety System
            </p>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="/static/js/main.js"></script>
    <script>
    function markNotificationsRead() {
        fetch('/notifications/mark-read', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        }).then(response => {
            if (response.ok) {
                const badge = document.getElementById('notif-badge');
                if (badge) badge.textContent = '0';
            }
        }).catch(error => console.error('Error:', error));
    }
    
    function markUserNotificationsRead() {
        const badge = document.getElementById('user-notif-badge');
        if (badge) {
            badge.style.display = 'none';
            badge.textContent = '0';
        }
        localStorage.setItem('userNotifLastRead', new Date().getTime());
    }
    
    // Mark notifications as read when panel is closed
    const userNotifPanel = document.getElementById('userNotificationPanel');
    if (userNotifPanel) {
        userNotifPanel.addEventListener('hidden.bs.offcanvas', function() {
            markUserNotificationsRead();
        });
    }
    
    {% if current_user and not current_user.is_admin %}
    function loadUserNotifications() {
        fetch('/api/user/report-updates')
            .then(r => r.json())
            .then(data => {
                const badge = document.getElementById('user-notif-badge');
                const content = document.getElementById('userNotifContent');
                const lastRead = localStorage.getItem('userNotifLastRead') ? parseInt(localStorage.getItem('userNotifLastRead')) : 0;
                
                console.log('User Notifications Debug:', {
                    totalUpdates: data.updates.length,
                    lastReadTime: new Date(lastRead).toLocaleString(),
                    updates: data.updates.map(u => ({
                        ticket: u.ticket_id,
                        updated: new Date(u.updated).toLocaleString(),
                        isNew: new Date(u.updated).getTime() > lastRead
                    }))
                });
                
                // Filter updates to only show those newer than last read time for badge count
                const newUpdates = data.updates.filter(update => {
                    const updateTime = new Date(update.updated).getTime();
                    return updateTime > lastRead;
                });
                
                // Show badge only if there are new updates
                if (newUpdates.length > 0) {
                    badge.textContent = newUpdates.length;
                    badge.style.display = 'block';
                    console.log(`✓ Showing badge with ${newUpdates.length} new updates`);
                } else {
                    badge.style.display = 'none';
                    console.log('✗ No new updates - badge hidden');
                }
                
                // But show ALL reports in the panel, not just new ones
                if (data.updates.length > 0) {
                    
                    let html = '<div class="list-group list-group-flush">';
                    // Show all updates, but highlight new ones
                    data.updates.forEach(update => {
                        const isNew = new Date(update.updated).getTime() > lastRead;
                        let iconClass, iconColor, borderClass, alertTitle;
                        
                        if (update.status === 'Resolved') {
                            iconClass = 'check-circle';
                            iconColor = 'success';
                            borderClass = 'border-success';
                            alertTitle = 'Resolution Completed';
                        } else if (update.status === 'In Progress') {
                            iconClass = 'hammer';
                            iconColor = 'info';
                            borderClass = 'border-info';
                            alertTitle = 'Maintenance In Progress';
                        } else {
                            iconClass = 'clock-history';
                            iconColor = 'warning';
                            borderClass = 'border-warning';
                            alertTitle = 'Pending Review';
                        }
                        
                        const timestamp = new Date(update.updated).toLocaleDateString('en-US', { 
                            month: 'short', 
                            day: 'numeric', 
                            year: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                        
                        html += `
                            <div class="list-group-item border-bottom" style="background-color: ${isNew ? '#f0f8ff' : 'white'};">
                                <div class="p-3">
                                    <div class="d-flex align-items-start gap-2 mb-2">
                                        <i class="bi bi-${iconClass} text-${iconColor} fs-5 mt-1 flex-shrink-0"></i>
                                        <div>
                                            <h6 class="mb-1">Report <code class="text-${iconColor}">${update.ticket_id}</code> - ${update.status}</h6>
                                            <small class="text-muted d-block">${update.title}</small>
                                        </div>
                                    </div>
                                    <div class="alert alert-light py-2 px-2 mb-2 border-start border-${iconColor} border-3">
                                        <small class="text-muted d-block mb-1"><strong>Status:</strong></small>
                                        <small>${alertTitle}</small>
                                    </div>
                                    <small class="text-muted d-block">${timestamp}</small>
                                </div>
                            </div>
                        `;
                    });
                    html += '</div>';
                    content.innerHTML = html;
                } else {
                    content.innerHTML = '<div class="text-center py-5"><i class="bi bi-bell-slash display-6 text-muted"></i><p class="text-muted mt-3">No updates</p></div>';
                    badge.style.display = 'none';
                }
            });
    }
    document.addEventListener('DOMContentLoaded', loadUserNotifications);
    {% elif current_user and current_user.is_admin %}
    function loadAdminNotifications() {
        fetch('/api/admin/notifications')
            .then(r => r.json())
            .then(data => {
                const badge = document.getElementById('notif-badge');
                const content = document.getElementById('notificationContent');
                
                if (data.unread_count > 0) {
                    badge.textContent = data.unread_count;
                    badge.style.display = 'block';
                } else {
                    badge.style.display = 'none';
                }
                
                if (data.notifications.length > 0) {
                    let html = '<div class="list-group list-group-flush">';
                    data.notifications.forEach(notif => {
                        let iconClass, iconColor, title;
                        
                        if (notif.type === 'report_submitted') {
                            iconClass = 'file-earmark-plus';
                            iconColor = 'primary';
                            title = 'New Report Submitted';
                        } else if (notif.type === 'report_deleted') {
                            iconClass = 'trash';
                            iconColor = 'danger';
                            title = 'Report Deleted';
                        } else {
                            iconClass = 'bell';
                            iconColor = 'info';
                            title = 'Notification';
                        }
                        
                        const timestamp = new Date(notif.created_at).toLocaleDateString('en-US', { 
                            month: 'short', 
                            day: 'numeric', 
                            year: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                        
                        html += `
                            <div class="list-group-item border-bottom" style="background-color: ${!notif.is_read ? '#f0f8ff' : 'white'};">
                                <div class="p-3">
                                    <div class="d-flex align-items-start gap-2 mb-2">
                                        <i class="bi bi-${iconClass} text-${iconColor} fs-5 mt-1 flex-shrink-0"></i>
                                        <div>
                                            <h6 class="mb-1">${title}</h6>
                                            <small class="text-muted d-block">${notif.user_name} (${notif.user_student_id})</small>
                                        </div>
                                    </div>
                                    ${notif.report_ticket_id ? `<p class="mb-1"><strong>Ticket:</strong> <code>${notif.report_ticket_id}</code></p>` : ''}
                                    ${notif.report_title ? `<p class="mb-1 small">${notif.report_title}</p>` : ''}
                                    ${notif.deletion_reason ? `<div class="alert alert-warning py-2 px-2 mb-2"><small><strong>Reason:</strong> ${notif.deletion_reason}</small></div>` : ''}
                                    <small class="text-muted d-block">${timestamp}</small>
                                </div>
                            </div>
                        `;
                    });
                    html += '</div>';
                    content.innerHTML = html;
                } else {
                    content.innerHTML = '<div class="text-center py-5"><i class="bi bi-bell-slash display-6 text-muted"></i><p class="text-muted mt-3">No notifications</p></div>';
                }
            });
    }
    document.addEventListener('DOMContentLoaded', loadAdminNotifications);
    {% endif %}
    
    // Password Toggle Functionality
    document.addEventListener('DOMContentLoaded', function() {
        const toggleButtons = document.querySelectorAll('.password-toggle');
        toggleButtons.forEach(button => {
            button.addEventListener('click', function(e) {
                e.preventDefault();
                const targetId = this.getAttribute('data-target');
                const field = document.getElementById(targetId);
                const icon = this.querySelector('i');
                
                if (field.type === 'password') {
                    field.type = 'text';
                    icon.classList.remove('bi-eye-slash');
                    icon.classList.add('bi-eye');
                } else {
                    field.type = 'password';
                    icon.classList.remove('bi-eye');
                    icon.classList.add('bi-eye-slash');
                }
            });
        });
    });
    </script>
    {% block extra_js %}{% endblock %}
</body>
</html>
